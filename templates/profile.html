{% extends "base.html" %}
{% block title %}STORM X - Profile{% endblock %}

{% block content %}
<div class="container py-3">
  <!-- Header -->
  <div class="glass-card p-3 mb-3 text-center">
    <div class="d-flex flex-column align-items-center">
      <div class="avatar-circle bg-primary text-white mb-2" style="width: 70px; height: 70px; font-size: 1.5rem;">
        <span>
          {% if user and user['first_name'] %}{{ user['first_name'][0]|upper }}{% endif %}{% if user and user['last_name'] %}{{ user['last_name'][0]|upper }}{% endif %}
        </span>
      </div>
      <h4 class="fw-bold mb-1">
        {% if user and user['first_name'] %}{{ user['first_name'] }}{% endif %} {% if user and user['last_name'] %}{{ user['last_name'] }}{% endif %}
      </h4>
      <p class="text-muted mb-2 small">@{% if user and user['username'] %}{{ user['username'] }}{% else %}No username{% endif %}</p>
      <div class="d-flex flex-wrap justify-content-center gap-1">
        <span class="badge bg-primary px-2 py-1 small"><i class="bi bi-coin me-1"></i> {% if user %}{{ user['credits'] }}{% else %}0{% endif %} Credits</span>
        <span class="badge bg-success px-2 py-1 small"><i class="bi bi-key me-1"></i> {{ user['access_key'][:4] }}...{{ user['access_key'][-4:] if user and user['access_key'] else 'N/A' }}</span>
        <span class="badge bg-info px-2 py-1 small"><i class="bi bi-calendar me-1"></i> {{ user['created_at'].split(' ')[0] if user and user['created_at'] else 'Unknown' }}</span>
      </div>
    </div>
  </div>

  <!-- Info Sections -->
  <div class="row g-3">
    <!-- Personal Info -->
    <div class="col-md-6">
      <div class="glass-card h-100">
        <div class="card-header bg-primary text-white py-2 px-3">
          <i class="bi bi-person-badge me-1"></i> Personal Info
        </div>
        <div class="card-body p-3">
          <div class="mb-2">
            <small class="text-muted d-block"><i class="bi bi-person me-1"></i> Full Name</small>
            <div class="small">{{ user['first_name'] if user else '' }} {{ user['last_name'] if user else '' }}</div>
          </div>
          <div class="mb-2">
            <small class="text-muted d-block"><i class="bi bi-at me-1"></i> Username</small>
            <div class="small">@{{ user['username'] if user else 'Not provided' }}</div>
          </div>
          <div class="mb-2">
            <small class="text-muted d-block"><i class="bi bi-key me-1"></i> Access Key</small>
            <div class="small font-monospace">{{ user['access_key'] if user else 'N/A' }}</div>
          </div>
          <div>
            <small class="text-muted d-block"><i class="bi bi-calendar me-1"></i> Member Since</small>
            <div class="small">{{ user['created_at'] if user else 'Unknown' }}</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Telegram Info -->
    <div class="col-md-6">
      <div class="glass-card h-100">
        <div class="card-header bg-info text-white py-2 px-3">
          <i class="bi bi-telegram me-1"></i> Telegram Info
        </div>
        <div class="card-body p-3">
          <div class="mb-2">
            <small class="text-muted d-block"><i class="bi bi-chat-dots me-1"></i> Telegram ID</small>
            <div class="small">{{ user['telegram_id'] if user else 'N/A' }}</div>
          </div>
          <div class="mb-2">
            <small class="text-muted d-block"><i class="bi bi-link-45deg me-1"></i> Bot Link</small>
            <div class="small">
              <a href="https://t.me/Getaccess3bot" target="_blank" class="text-decoration-none">t.me/Getaccess3bot</a>
            </div>
          </div>
          <div>
            <small class="text-muted d-block"><i class="bi bi-robot me-1"></i> Commands</small>
            <div class="mt-1">
              <span class="badge bg-secondary me-1 small">/start</span>
              <span class="badge bg-secondary me-1 small">/credits</span>
              <span class="badge bg-secondary small">/help</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Bot Settings -->
    <div class="col-md-6">
      <div class="glass-card h-100">
        <div class="card-header bg-dark text-white py-2 px-3">
          <i class="bi bi-gear me-1"></i> Bot Settings
        </div>
        <div class="card-body p-3">
          <form method="POST" action="{{ url_for('save_bot') }}">
            <div class="mb-2">
              <small class="text-muted d-block"><i class="bi bi-key me-1"></i> Bot Token</small>
              <input type="text" name="bot_token" class="form-control form-control-sm"
                     value="{{ user['bot_token'] if user and user['bot_token'] else '' }}">
            </div>
            <div class="mb-2">
              <small class="text-muted d-block"><i class="bi bi-hash me-1"></i> Chat ID</small>
              <input type="text" name="chat_id" class="form-control form-control-sm"
                     value="{{ user['chat_id'] if user and user['chat_id'] else '' }}">
            </div>
            <button type="submit" class="btn btn-sm btn-primary mt-2">
              <i class="bi bi-save me-1"></i> Save Bot Settings
            </button>
            <div class="form-text small mt-2">
              <i class="bi bi-info-circle"></i> To get your bot token and chat ID, create a bot with @BotFather on Telegram
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Credit Info -->
    <div class="col-md-6">
      <div class="glass-card h-100">
        <div class="card-header bg-warning text-dark py-2 px-3">
          <i class="bi bi-coin me-1"></i> Credit Info
        </div>
        <div class="card-body p-3 text-center">
          <h3 class="fw-bold text-warning mb-1">{{ user['credits'] if user else 0 }}</h3>
          <p class="small text-muted mb-2">Available Credits</p>
          {% if user and user['credits'] <= 0 %}
            <div class="alert alert-danger py-1 px-2 small mb-2"><i class="bi bi-exclamation-triangle me-1"></i> Out of credits!</div>
          {% elif user and user['credits'] < 10 %}
            <div class="alert alert-warning py-1 px-2 small mb-2"><i class="bi bi-info-circle me-1"></i> Running low</div>
          {% else %}
            <div class="alert alert-success py-1 px-2 small mb-2"><i class="bi bi-check-circle me-1"></i> Sufficient</div>
          {% endif %}
          <a href="https://t.me/Getaccess3bot" class="btn btn-primary btn-sm mt-1"><i class="bi bi-robot me-1"></i> Get More</a>
        </div>
      </div>
    </div>

    <!-- Account Stats -->
    <div class="col-md-6">
      <div class="glass-card h-100">
        <div class="card-header bg-success text-white py-2 px-3">
          <i class="bi bi-graph-up me-1"></i> Statistics
        </div>
        <div class="card-body p-3">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <small class="text-muted"><i class="bi bi-credit-card me-1"></i> Cards Checked</small>
            <span class="fw-bold small">{{ user['approved_count'] + user['declined_count'] if user else 0 }}</span>
          </div>
          <div class="d-flex justify-content-between align-items-center mb-2">
            <small class="text-muted"><i class="bi bi-check-circle me-1"></i> Successful</small>
            <span class="fw-bold text-success small">{{ user['approved_count'] if user else 0 }}</span>
          </div>
          <div class="d-flex justify-content-between align-items-center mb-2">
            <small class="text-muted"><i class="bi bi-x-circle me-1"></i> Failed</small>
            <span class="fw-bold text-danger small">{{ user['declined_count'] if user else 0 }}</span>
          </div>
          <div class="d-flex justify-content-between align-items-center">
            <small class="text-muted"><i class="bi bi-percent me-1"></i> Success Rate</small>
            <span class="fw-bold small">
              {% if user and (user['approved_count'] + user['declined_count']) > 0 %}
                {{ (user['approved_count'] / (user['approved_count'] + user['declined_count']) * 100) | round(1) }}%
              {% else %}
                0%
              {% endif %}
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- Recent Card Checks -->
    <div class="col-md-6">
      <div class="glass-card h-100">
        <div class="card-header bg-secondary text-white py-2 px-3">
          <i class="bi bi-clock-history me-1"></i> Recent Card Checks
        </div>
        <div class="card-body p-3">
          {% if card_logs %}
            {% for log in card_logs %}
            <div class="mb-2 pb-2 {% if not loop.last %}border-bottom{% endif %}">
              <div class="d-flex justify-content-between align-items-center">
                <small class="text-muted">{{ log['created_at'] }}</small>
                <span class="badge {% if log['status'] == 'Approved' %}bg-success{% else %}bg-danger{% endif %} small">
                  {{ log['status'] }}
                </span>
              </div>
              <div class="small font-monospace">{{ log['card_data'][:20] }}...</div>
              <div class="small text-muted">{{ log['gateway'] }} - {{ log['response'][:30] }}...</div>
            </div>
            {% endfor %}
          {% else %}
            <div class="text-center text-muted py-3">
              <i class="bi bi-inbox display-6 d-block mb-2"></i>
              <p class="small">No card checks yet</p>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Access Logs -->
  <div class="glass-card mt-3">
    <div class="card-header bg-secondary text-white py-2 px-3">
      <i class="bi bi-clock-history me-1"></i> Recent Access Logs
    </div>
    <div class="card-body p-3">
      <div class="table-responsive">
        <table class="table table-sm table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th class="small py-1">Date & Time</th>
              <th class="small py-1">IP Address</th>
              <th class="small py-1">Access Key</th>
              <th class="small py-1">Status</th>
            </tr>
          </thead>
          <tbody>
            {% if access_logs %}
              {% for log in access_logs %}
              <tr>
                <td class="small py-1">{{ log['accessed_at'] if log['accessed_at'] else 'Unknown' }}</td>
                <td class="small py-1">{{ log['ip_address'] if log['ip_address'] else 'Unknown' }}</td>
                <td class="small font-monospace py-1">{{ log['access_key'][:4] }}****{{ log['access_key'][-4:] if log['access_key'] and log['access_key']|length > 8 else '' }}</td>
                <td class="small py-1"><span class="badge bg-success">Active</span></td>
              </tr>
              {% endfor %}
            {% else %}
              <tr><td colspan="4" class="text-center py-3 small">No access logs found</td></tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<style>
.avatar-circle {
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
}
.glass-card {
  background: rgba(255, 255, 255, 0.9);
  backdrop-filter: blur(10px);
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  border: 1px solid rgba(255,255,255,0.2);
}
body.dark-mode .glass-card {
  background: rgba(20, 20, 20, 0.9);
  border: 1px solid rgba(255,255,255,0.1);
}
.card-header {
  font-weight: 600;
  font-size: 0.9rem;
}
.small { font-size: 0.85rem; }
.table th, .table td { padding: 0.4rem 0.5rem; }
.alert { font-size: 0.8rem; margin-bottom: 0.5rem; }
.btn-sm { padding: 0.25rem 0.5rem; font-size: 0.8rem; }
.badge { font-size: 0.75rem; font-weight: 500; }
</style>
{% endblock %}
